Configuration with Minigraph:

SONiC is using device minigraph as a single entry to configure the box

The minigraph file is at /etc/sonic/minigraph.xml. The actually configuration for each docker is automatically generated based on this file.

Minigraph

Device minigraph contains all the information about a given device.
In particularly it has all the information need to generate the device configuration as well as other data plan and control plane related information.


Device information:

	Hostname and SKU information is defined as of root element <DeviceMiniGraph>
	<DeviceMiniGraph>
  	...
  	<Hostname>switch1</Hostname>
  	<HwSku>AS7512</HwSku>
	</DeviceMiniGraph>

	<PngDec> session and the Type/Role for the device is also defined there.
	
	<PngDec>
    	...
    	<Devices>
      	<Device i:type="LeafRouter">
        		<Hostname>switch1</Hostname>
        		<HwSku>AS7512</HwSku>
      	</Device>
    	</Devices>

	</PngDec>

Loopback address (IPV4 and IPV6) and Management address (IPV4 and IPV6) are defined in <DpgDec> session


<DpgDec>
    <DeviceDataPlaneInfo>
      <IPSecTunnels/>
      <LoopbackIPInterfaces xmlns:a="http://schemas.datacontract.org/2004/07/Microsoft.Search.Autopilot.Evolution">
        <a:LoopbackIPInterface>
          <Name>HostIP</Name>
          <AttachTo>Loopback0</AttachTo>
          <a:Prefix xmlns:b="Microsoft.Search.Autopilot.NetMux">
            <b:IPPrefix>100.0.0.10/32</b:IPPrefix>
          </a:Prefix>
          <a:PrefixStr>100.0.0.10/32</a:PrefixStr>
        </a:LoopbackIPInterface>
      </LoopbackIPInterfaces>
      <ManagementIPInterfaces xmlns:a="http://schemas.datacontract.org/2004/07/Microsoft.Search.Autopilot.Evolution">
        <a:ManagementIPInterface>
          <Name>ManagementIP1</Name>
          <AttachTo>Management0</AttachTo>
          <a:Prefix xmlns:b="Microsoft.Search.Autopilot.NetMux">
            <b:IPPrefix>192.168.200.19/24</b:IPPrefix>
          </a:Prefix>
          <a:PrefixStr>192.168.200.19/24</a:PrefixStr>
        </a:ManagementIPInterface>
      </ManagementIPInterfaces>
    ...
    </DeviceDataPlaneInfo>
  </DpgDec>

Device Metadata:

DHCP servers, NTP servers and Syslog servers should be defined in the device's minigraph file as properties of the device's metadata, in a semicolon-delimited list.

<MetadataDeclaration>
  <Devices xmlns:a="http://schemas.datacontract.org/2004/07/Microsoft.Search.Autopilot.Evolution">
    <a:DeviceMetadata>
      <a:Name>switch1</a:Name>
      <a:Properties>
        <a:DeviceProperty>
          <a:Name>DhcpResources</a:Name>
          <a:Reference i:nil="true"/>
          <a:Value>192.0.0.1;192.0.0.2;192.0.0.3;192.0.0.4</a:Value>
        </a:DeviceProperty>
        <a:DeviceProperty>
          <a:Name>NtpResources</a:Name>
          <a:Reference i:nil="true"/>
          <a:Value>0.debian.pool.ntp.org;1.debian.pool.ntp.org;2.debian.pool.ntp.org;3.debian.pool.ntp.org</a:Value>
        </a:DeviceProperty>
        <a:DeviceProperty>
          <a:Name>SyslogResources</a:Name>
          <a:Reference i:nil="true"/>
          <a:Value>192.0.0.1</a:Value>
        </a:DeviceProperty>
      </a:Properties>
    </a:DeviceMetadata>
  </Devices>
</MetadataDeclaration>


Device Links:

All the links start and end at the device and Metadata associated with all the links (name value pairs) are in <PngDec> session.


 <PngDec>
    <DeviceInterfaceLinks>
      <DeviceLinkBase i:type="DeviceInterfaceLink">
        <Bandwidth>40000</Bandwidth>
        <ElementType>DeviceInterfaceLink</ElementType>
        <EndDevice>OCPSCH0104001MS</EndDevice>
        <EndPort>Ethernet0</EndPort>
        <StartDevice>OCPSCH01040HHLF</StartDevice>
        <StartPort>Ethernet0</StartPort>
      </DeviceLinkBase>
      <DeviceLinkBase i:type="DeviceInterfaceLink">
        <Bandwidth>40000</Bandwidth>
        <ElementType>DeviceInterfaceLink</ElementType>
        <EndDevice>OCPSCH0104002MS</EndDevice>
        <EndPort>Ethernet0</EndPort>
        <StartDevice>OCPSCH01040HHLF</StartDevice>
        <StartPort>Ethernet4</StartPort>
      </DeviceLinkBase>
    </DeviceInterfaceLinks>
    ...
  </PngDec>



DeviceDataPlaneInfo:

All the device data plane information are defined in the <DpgDec> session, including IP addresses,
 Port channel settings, Vlan definitions, and ACL attaching information.

Please note the AclInterfaces element in minigraph only contains the mapping from ACL table names to interfaces.
The detailed ACL tables are defined with same table names in another file, /etc/sonic/acl.json,

<DpgDec>
    <DeviceDataPlaneInfo>
      ...
      <PortChannelInterfaces>
        <PortChannel>
          <Name>PortChannel01</Name>
          <AttachTo>Ethernet112</AttachTo>
          <SubInterface/>
        </PortChannel>
        <PortChannel>
          <Name>PortChannel02</Name>
          <AttachTo>Ethernet116</AttachTo>
          <SubInterface/>
        </PortChannel>
      </PortChannelInterfaces>
      <VlanInterfaces>
        <VlanInterface>
          <Name>Vlan1000</Name>
          <AttachTo>Ethernet8;Ethernet12;Ethernet16;Ethernet20</AttachTo>
          <Type i:nil="true"/>
          <VlanID>1000</VlanID>
          <Tag>1000</Tag>
          <Subnets>192.168.0.0/27</Subnets>
        </VlanInterface>
      </VlanInterfaces>
      <IPInterfaces>
        <IPInterface>
          <Name i:nil="true"/>
          <AttachTo>PortChannel01</AttachTo>
          <Prefix>10.0.0.56/31</Prefix>
        </IPInterface>
        <IPInterface>
          <Name i:Name="true"/>
          <AttachTo>PortChannel01</AttachTo>
          <Prefix>FC00::71/126</Prefix>
        </IPInterface>
        <IPInterface>
          <Name i:nil="true"/>
          <AttachTo>PortChannel02</AttachTo>
          <Prefix>10.0.0.58/31</Prefix>
        </IPInterface>
        <IPInterface>
          <Name i:Name="true"/>
          <AttachTo>PortChannel02</AttachTo>
          <Prefix>FC00::75/126</Prefix>
        </IPInterface>
        <IPInterface>
          <Name i:nil="true"/>
          <AttachTo>Vlan1000</AttachTo>
          <Prefix>192.168.0.1/27</Prefix>
        </IPInterface>
        <IPInterface>
          <Name i:nil="true"/>
          <AttachTo>Ethernet0</AttachTo>
          <Prefix>10.10.1.1/30</Prefix>
        </IPInterface>
        <IPInterface>
          <Name i:nil="true"/>
          <AttachTo>Ethernet4</AttachTo>
          <Prefix>10.10.2.1/30</Prefix>
        </IPInterface>
      </IPInterfaces>
      <AclInterfaces>
        <AclInterface>
          <AttachTo>ERSPAN</AttachTo>
          <InAcl>everflow</InAcl>
        </AclInterface>
        <AclInterface>
          <AttachTo>
            PortChannel01;PortChannel02
          </AttachTo>
          <InAcl>data_acl</InAcl>
        </AclInterface>
      </AclInterfaces>
      ...
    </DeviceDataPlaneInfo>
  </DpgDec>

BGP information:

BGP AS Number, Peers and Peering sessions are defined in the <CpgDec> session.

  <CpgDec>
    ...
    <PeeringSessions>
      <BGPSession>
        <StartRouter>OCPSCH0104001MS</StartRouter>
        <StartPeer>10.10.1.18</StartPeer>
        <EndRouter>OCPSCH01040EELF</EndRouter>
        <EndPeer>10.10.1.17</EndPeer>
        <Multihop>1</Multihop>
        <HoldTime>10</HoldTime>
        <KeepAliveTime>3</KeepAliveTime>
      </BGPSession>
      <BGPSession>
        <StartRouter>OCPSCH0104002MS</StartRouter>
        <StartPeer>10.10.2.18</StartPeer>
        <EndRouter>OCPSCH01040EELF</EndRouter>
        <EndPeer>10.10.2.17</EndPeer>
        <Multihop>1</Multihop>
        <HoldTime>10</HoldTime>
        <KeepAliveTime>3</KeepAliveTime>
      </BGPSession>
    </PeeringSessions>
    <Routers xmlns:a="http://schemas.datacontract.org/2004/07/Microsoft.Search.Autopilot.Evolution">
      <a:BGPRouterDeclaration>
        <a:ASN>64536</a:ASN>
        <a:Hostname>OCPSCH01040EELF</a:Hostname>
        <a:Peers>
          <BGPPeer>
            <Address>10.10.1.18</Address>
            <RouteMapIn i:nil="true"/>
            <RouteMapOut i:nil="true"/>
          </BGPPeer>
          <BGPPeer>
            <Address>10.10.2.18</Address>
            <RouteMapIn i:nil="true"/>
            <RouteMapOut i:nil="true"/>
          </BGPPeer>
        </a:Peers>
        <a:RouteMaps/>
      </a:BGPRouterDeclaration>
      <a:BGPRouterDeclaration>
        <a:ASN>64542</a:ASN>
        <a:Hostname>OCPSCH0104001MS</a:Hostname>
        <a:RouteMaps/>
      </a:BGPRouterDeclaration>
      <a:BGPRouterDeclaration>
        <a:ASN>64543</a:ASN>
        <a:Hostname>OCPSCH0104002MS</a:Hostname>
        <a:RouteMaps/>
      </a:BGPRouterDeclaration>
    </Routers>
  </CpgDec>


Configuration Generation:

The application configuration file for each docker / SONiC feature are automatically generated base on minigraph data, 
as illustrated in the following figure.


Device Minigraph Generation and Deployment:

Different topologies requires different configuration/minigraph on the DUT. 
testbed-cli.sh gen-mg|deploy-mg allows to generate and deploy minigraph to the DUT based on the topology type.


 first prepare inventory file and testbed.csv file.

	./testbed-cli.sh deploy-mg vms-sn2700-t0 lab password.txt


The tool works as follows:

Read the testbed info from testbed.csv using the testbed name.

Read the topology information defined in topology file vars/topo_{{ topology_name}}.yml

Read the VMs information from the veos inventory file.

Generate minigraph based on minigraph templates in templates folder.

Deploy minigraph to the DUT.

Load the minigraph on DUT.

Save the configuration in config db.



















